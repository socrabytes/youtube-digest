name: "Auto-Bug-Column"

on:
  issues:
    types: [labeled]  # Add "opened" if you want to catch issues that start labeled via a template

jobs:
  move_bug_issues:
    if: github.event.label.name == 'bug'
    runs-on: ubuntu-latest
    permissions: 
      contents: read
      issues: read
      repository-projects: write
    env:
      EVENT_CONTEXT: ${{ toJson(github.event) }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}              # Required for gh CLI calls
      PROJECT_ID: "PVT_kwHOBpT7s84Auc0_"                 # Static Project ID
      STATUS_FIELD_ID: "PVTSSF_lAHOBpT7s84Auc0_zglCzjk"  # Static Field ID for "Status" 
      BUGS_OPTION_ID: "46438b8c"                         # Static Option ID for "ðŸª³Bugs"
    steps:
      - name: Show Issue Info
        run: |
          echo "Action: ${{ github.event.action }}"
          echo "Issue Number: ${{ github.event.issue.number }}"

      - name: Retrieve Project Item
        run: |
          ITEM_ID=$(gh issue view "${{ github.event.issue.number }}" \
            --json projectItems \
            --jq ".projectItems[] | select(.project.id == \"$PROJECT_ID\") | .id")

          echo "ITEM_ID: $ITEM_ID"
          echo "ITEM_ID=$ITEM_ID" >> $GITHUB_ENV

      - name: Move to Bugs Column
        if: env.ITEM_ID != ''
        run: |
          echo "Moving Issue #${{ github.event.issue.number }} to the Bugs column."
          gh project item-edit \
            --id "$ITEM_ID" \
            --field-id "$STATUS_FIELD_ID" \
            --project-id "$PROJECT_ID" \
            --single-select-option-id "$BUGS_OPTION_ID"
